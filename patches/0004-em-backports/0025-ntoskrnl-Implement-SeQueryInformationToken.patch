From fa1490087b3b3c38776df9d1a3da6eb53530a6de Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Wed, 23 Jul 2025 00:45:06 -0400
Subject: [PATCH 25/44] ntoskrnl: Implement SeQueryInformationToken.

---
 dlls/ntoskrnl.exe/ntoskrnl.c        | 18 ++++++++++++++++++
 dlls/ntoskrnl.exe/ntoskrnl.exe.spec |  2 +-
 2 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/dlls/ntoskrnl.exe/ntoskrnl.c b/dlls/ntoskrnl.exe/ntoskrnl.c
index 9b32899bffe..cffa2feff10 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.c
+++ b/dlls/ntoskrnl.exe/ntoskrnl.c
@@ -4586,6 +4586,24 @@ static struct _OBJECT_TYPE token_type =
 
 POBJECT_TYPE SeTokenObjectType = &token_type;
 
+NTSTATUS WINAPI SeQueryInformationToken(PACCESS_TOKEN token, TOKEN_INFORMATION_CLASS class, void **info)
+{
+    HANDLE handle;
+    NTSTATUS status;
+    /* FIXME: calculate size dynamically */
+    const ULONG size = 0x1000;
+    TRACE("%p %u %p\n", token, class, info);
+
+    if ((status = ObOpenObjectByPointer( token, OBJ_KERNEL_HANDLE, NULL, TOKEN_ALL_ACCESS, SeTokenObjectType, KernelMode, &handle )))
+        return status;
+
+    *info = ExAllocatePool(PagedPool, size);
+
+    if (!*info) return STATUS_NO_MEMORY;
+
+    return NtQueryInformationToken(handle, class, *info, size, NULL);
+}
+
 /*************************************************************************
  *           ExUuidCreate            (NTOSKRNL.@)
  *
diff --git a/dlls/ntoskrnl.exe/ntoskrnl.exe.spec b/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
index 9712f2aade7..e60bfcb466a 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
+++ b/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
@@ -1369,7 +1369,7 @@
 @ stub SePrivilegeObjectAuditAlarm
 @ stub SePublicDefaultDacl
 @ stub SeQueryAuthenticationIdToken
-@ stub SeQueryInformationToken
+@ stdcall SeQueryInformationToken(ptr long ptr)
 @ stub SeQuerySecurityDescriptorInfo
 @ stub SeQuerySessionIdToken
 @ stub SeRegisterLogonSessionTerminatedRoutine
-- 
2.52.0

