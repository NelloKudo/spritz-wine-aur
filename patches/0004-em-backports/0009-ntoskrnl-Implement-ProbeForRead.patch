From 2c60533fec47bdfd2a1d55f799861b29e30be7bf Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Tue, 22 Jul 2025 15:44:05 -0400
Subject: [PATCH 09/44] ntoskrnl: Implement ProbeForRead.

---
 dlls/ntoskrnl.exe/ntoskrnl.c | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/dlls/ntoskrnl.exe/ntoskrnl.c b/dlls/ntoskrnl.exe/ntoskrnl.c
index ad7ec4333f9..0a583639672 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.c
+++ b/dlls/ntoskrnl.exe/ntoskrnl.c
@@ -3735,7 +3735,17 @@ void WINAPI KeBugCheckEx(ULONG code, ULONG_PTR param1, ULONG_PTR param2, ULONG_P
  */
 void WINAPI ProbeForRead(void *address, SIZE_T length, ULONG alignment)
 {
-    FIXME("(%p %Iu %lu) stub\n", address, length, alignment);
+    TRACE("(%p %Iu %lu)\n", address, length, alignment);
+
+    if (length == 0) return;
+
+    if ((ULONG_PTR)address & (alignment-1))
+        RtlRaiseStatus(STATUS_DATATYPE_MISALIGNMENT);
+
+    if ((ULONG_PTR)address + length < (ULONG_PTR)address)
+        RtlRaiseStatus(STATUS_ACCESS_VIOLATION);
+
+    /* TODO: Check if within address space */
 }
 
 /***********************************************************************
@@ -3747,8 +3757,7 @@ void WINAPI ProbeForWrite(void *address, SIZE_T length, ULONG alignment)
 
     if (length == 0) return;
 
-    if ((ULONG_PTR)address & (alignment-1))
-        RtlRaiseStatus(STATUS_DATATYPE_MISALIGNMENT);
+    ProbeForRead(address, length, alignment);
 
     for (volatile char *p = address; p < (char *)address + length; p++)
         *p |= 0;
-- 
2.52.0

