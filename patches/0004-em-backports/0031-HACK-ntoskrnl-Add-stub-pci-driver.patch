From 0972a88929c193858410528a14b29528fa7caa22 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Wed, 23 Jul 2025 15:17:03 -0400
Subject: [PATCH 31/44] HACK: ntoskrnl: Add stub pci driver.

---
 dlls/ntoskrnl.exe/ntoskrnl.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/dlls/ntoskrnl.exe/ntoskrnl.c b/dlls/ntoskrnl.exe/ntoskrnl.c
index b88b10c86af..8315576dada 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.c
+++ b/dlls/ntoskrnl.exe/ntoskrnl.c
@@ -4988,6 +4988,13 @@ BOOL WINAPI VslGetSecurePciEnabled(void)
     return TRUE;
 }
 
+static NTSTATUS WINAPI pci_driver_stub( DRIVER_OBJECT *driver, UNICODE_STRING *path )
+{
+    FIXME("%p %s stub!\n", driver, debugstr_us(path));
+
+    return STATUS_SUCCESS;
+}
+
 /*****************************************************
  *           DllMain
  */
@@ -4995,6 +5002,7 @@ BOOL WINAPI DllMain( HINSTANCE inst, DWORD reason, LPVOID reserved )
 {
     static void *handler;
     LARGE_INTEGER count;
+    UNICODE_STRING str = RTL_CONSTANT_STRING( L"\\Driver\\pci" );
 
     switch(reason)
     {
@@ -5008,6 +5016,7 @@ BOOL WINAPI DllMain( HINSTANCE inst, DWORD reason, LPVOID reserved )
         ntoskrnl_heap = HeapCreate( HEAP_CREATE_ENABLE_EXECUTE, 0, 0 );
         dpc_call_tls_index = TlsAlloc();
         LdrRegisterDllNotification( 0, ldr_notify_callback, NULL, &ldr_notify_cookie );
+        IoCreateDriver(&str, pci_driver_stub);
         break;
     case DLL_PROCESS_DETACH:
         LdrUnregisterDllNotification( ldr_notify_cookie );
-- 
2.52.0

