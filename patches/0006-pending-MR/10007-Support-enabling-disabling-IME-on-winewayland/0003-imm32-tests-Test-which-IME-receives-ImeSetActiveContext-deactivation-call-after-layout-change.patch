From c6572a15d8d4fda1caca96f1e5e0a3a4c55cdff7 Mon Sep 17 00:00:00 2001
From: Ziia Shi <mkrsym1@gmail.com>
Date: Tue, 3 Feb 2026 18:30:01 +0100
Subject: [PATCH] imm32/tests: Test which IME receives ImeSetActiveContext
 deactivation call after layout change.

---
 dlls/imm32/tests/imm32.c | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/dlls/imm32/tests/imm32.c b/dlls/imm32/tests/imm32.c
index fed49315d3b..92201dcfeb9 100644
--- a/dlls/imm32/tests/imm32.c
+++ b/dlls/imm32/tests/imm32.c
@@ -5584,6 +5584,27 @@ static void test_ImmSetActiveContext(void)
 
     ok_ret( 1, ImmActivateLayout( hkl ) );
     ok_ret( 1, ImmLoadIME( hkl ) );
+    ok_ret( 1, ImmSetActiveContext( hwnd, default_himc, TRUE ) );
+    ok_ret( 1, ImmActivateLayout( default_hkl ) );
+    ok_ret( 1, ImmLoadIME( default_hkl ) );
+    process_messages();
+    memset( ime_calls, 0, sizeof(ime_calls) );
+    ime_call_count = 0;
+    ok_ret( 1, ImmSetActiveContext( hwnd, default_himc, FALSE ) );
+    ok_seq( empty_sequence );
+
+    ok_ret( 1, ImmFreeLayout( hkl ) );
+
+    ok_ret( 1, ImmSetActiveContext( hwnd, default_himc, TRUE ) );
+    ok_ret( 1, ImmActivateLayout( hkl ) );
+    ok_ret( 1, ImmLoadIME( hkl ) );
+    process_messages();
+    memset( ime_calls, 0, sizeof(ime_calls) );
+    ime_call_count = 0;
+    ok_ret( 1, ImmSetActiveContext( hwnd, default_himc, FALSE ) );
+    ok_seq( deactivate_0_seq );
+
+    ok_ret( 1, ImmFreeLayout( default_hkl ) );
     process_messages();
     memset( ime_calls, 0, sizeof(ime_calls) );
     ime_call_count = 0;
-- 
GitLab

